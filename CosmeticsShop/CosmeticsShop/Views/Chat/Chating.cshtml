@{
    ViewBag.Title = "Chat";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="card">
    <div class="card-header">Chat</div>
    <div class="card-body" id="chatMessages" style="height:300px; overflow-y:auto;"></div>
    <div class="card-footer">
        <input type="text" id="messageInput" class="form-control" placeholder="Nhập tin nhắn..." />
        <button id="sendBtn" class="btn btn-primary mt-2">Gửi</button>
    </div>
</div>

<script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
<script src="/signalr/hubs"></script>
<script>
    var chat = $.connection.chatHubs;

    chat.client.receiveMessage = function (msg) {
        loadMessages();
    };

    $.connection.hub.start().done(function () {
        $("#sendBtn").click(function () {
            var content = $("#messageInput").val();
            if (content.trim() !== "") {
                chat.server.sendMessage(@ViewBag.CurrentUserID, @ViewBag.WithUserID, content);
                $("#messageInput").val("");
            }
        });
    });

    function loadMessages() {
        $.getJSON("/Chat/GetMessages?userId=@ViewBag.WithUserID", function (data) {
            var html = "";
            $.each(data, function (i, m) {
                html += "<div><strong>" + m.FromUserName + ":</strong> " + m.Content + " <small>(" + m.CreatedDate + ")</small></div>";
            });
            $("#chatMessages").html(html);
            $("#chatMessages").scrollTop($("#chatMessages")[0].scrollHeight);
        });
    }

    loadMessages();
</script>
